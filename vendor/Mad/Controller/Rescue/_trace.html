<?php
  $point = array('file' => $this->exception->getFile(),
                 'line' => $this->exception->getLine(),
                 'class' => $this->controller,
                 'type' => '->',
                 'function' => $this->action);
  $trace = $this->exception->getTrace();
  array_unshift($trace, $point);
?>

<p><code>MAD_ROOT: <?php if (defined('MAD_ROOT')): ?><?php echo MAD_ROOT ?><?php else: ?>unset<?php endif ?></code></p>

<div id="traces">
  <div id="Application-Trace" style="display: block;">
    <pre><code><?php $madRoot = rtrim(MAD_ROOT, '/'.DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR;
                     foreach($trace as $point): 
                      $point = new Mad_Support_ArrayObject($point);
                      echo str_replace($madRoot, '', $point['file']) .'('. $point['line'] .') in '. $point['class'] .$point['type'].$point['function'] ."\n";
                     endforeach ?></pre>
  </div>
</div>

<?php if ($this->extraction): ?>
Extracted source (around line #<?php echo $this->extraction->line ?>):
<pre>
<?php
 end($this->extraction->source);
 $width = strlen(key($this->extraction->source));

 foreach ($this->extraction->source as $line => $code) {
   echo str_repeat(' ', $width-strlen($line)) . $line;
   echo ': ' . htmlentities($code) ."\n";
 }

?>
</pre>
<?php endif ?>
